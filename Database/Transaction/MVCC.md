#### MVCC

---

##### 摘要



#### MVCC介绍

---

##### 什么是MVCC:

> MVCC: 全称Multi-Version Concurrency Control, 即多版本控制

MVCC的目的主要是为了提高数据库并发性能, 用更好的方式去处理读写冲突, 即使有读写冲突时, 也能做到不加锁.

这里的多版本指的是数据库中同时存在多个版本的数据, 并不是整个数据库的多个版本, 而是某一条数据有多个版本同时存在.

##### 并发控制的挑战:

##### MVCC的优点:

MVCC机制具有以下特点:

1. 提高并发性能:
2. 降低死锁的风险:



#### 当前读和快照读

---

##### 当前读:

##### 快照读:



#### MVCC原理分析

---

##### 隐藏字段

MySql中的行数据, 除了我们肉眼能看到的字段之外, 其实还包含了一些隐藏字段, 它们在内部使用, 默认情况下不会展示给用户.

| 字段        | 含义                                                         |
| ----------- | ------------------------------------------------------------ |
| DB_ROW_ID   |                                                              |
| DB_TRX_ID   |                                                              |
| DB_ROLL_PTR | 该字段存储了回滚指针(Roll Pointer), 它指向用于回滚事务的Undo日记记录. |

##### Undo Log

上文提到了Undo日志, 这个Undo日志是MVCC能够得以实现的核心所在.

Undo日志(Undo Log)是Mysql中的一种重要的事务日志, Undo日志的作用主要有两个方面.

- 事务回滚: 当事务需要回滚时, MySql可以通过Undo日志中的旧值将数据还原到事务开始之前的状态, 保证了事务回滚的一致性.
- MVCC实现: MVCC是InnoDB存储引擎的核心特性之一. 通过使用Undo日志, Mysql可以为每个事务提供独立的事务视图, 使得事务读取数据时能看到一致且符合隔离级别的数据版本.

##### 版本链

在MVCC中, 对于每次更新操作, 旧值会被保存到一条undo日志中, 即使它是该记录的旧版本. 随着更新次数的增加, 所有的版本都会通过roll_point属性连接成一个链表, 称之为版本链.

版本链的头节点记录的是当前记录的最新值. 此外, 每个版本还包含生成该版本的事务ID.

##### Read View

> 一致性视图, 全称Read View, 是用来判断版本链中的哪个版本对当前事务是可见的

Read View说白了就是事务进行快照读时候生成的读视图(Read View), 在该事务执行快照读的那一刻, 会生成数据库系统当前的一个快照, 记录并维护系统当前活跃的事务ID.

##### Read View可读性原则

Read View遵循一个可见性原则, 将要被修改的数据的DB_TRX_ID取出来, 与系统当前其它活跃事务ID去对比.

如果DB_TRX_ID跟Read View的属性做了某些比较, 不符合可见性, 那就通过DB_ROLL_PTR回滚指针去取出Undo Log中的DB_TRX_ID再比较.

即遍历链表的DB_TRX_ID, 直到找到满足特定条件的DB_TRX_ID, 那么这个DB_TRX_ID所在的记录就是当前事务能看见的最新老版本.



#### 事务隔离级别下的的Read View

---

RU和Serializable是两个特殊的隔离级别, 它们不需要Read View的主要原因:

1. RU隔离级别: 在RU隔离级别下, 事务可以读取其它事务尚未提交的数据, 即脏读. 这意味着不需要通过Read View来限制访问范围, 事务可以读取其它事务未提交的数据. 由于没有对可见行进行严格控制, 因此不需要创建和事务Read View.
2. Serializable隔离级别: 在Serializable隔离级别下, 事务具有最高的隔离性, 确保每次读取都能看到一致的快照. 为了实现这种隔离级别, Mysql使用锁机制来保证事务之间的穿行执行. 由于事务按顺序执行, 并且不允许并发操作, 所以不需要使用Read View进行可见行判断.

RC和RR下生成的Read View的时机是有所差异的:

1. RC: 每次SELECT数据前都生成
2. RR: 只在第一次读取数据时生成一个Read View, 后面会复用第一次生成的.



#### RR级别下能否防住幻读

---



#### 总结

---







https://cloud.tencent.com/developer/article/2378614
