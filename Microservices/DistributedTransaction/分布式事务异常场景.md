#### 分布式事务异常场景

---

##### 缺乏隔离性的应对：

案例:

​	场景: 手机充值

​	先给用户A充值，然后给用户B扣款，如果在给用户A充值成功，在事务提交之前，用户A把余额给消费掉了，事务发生

​	回滚，这时则无法进行补偿了。 

错误案例:

​	场景: 审批退款

​	用户发起退款申请，管理员审核通过，则进行退款逻辑流程：

​	- 如果用户支付时使用了积分, 则退积分

​	- 如果用户支付时使用了优惠券，则退优惠券

​	- 如果用户支付时使用了现金，则发起退款申请

​	所有上述流程都是异步执行，最后在统一业务中修改退款状态为完成

​	如果退款申请执行失败，则积分和优惠券无法追回	

应对方法:

 1. 业务流程设计遵循"宁可长款，不可短款"的原则，长款的意思是客户少了钱机构多了钱，以机构信誉可以给用户退款，

    反之则是短款，少的钱可能追不回来了。所以在业务流程上一定是先扣款。

2. 有些业务场景可以允许让业务最终成功，在回滚不了的情况下可以继续重试完成后面的流程，所以状态机引擎出了提供

   "回滚"能力还需要提供"向前"回复上下文继续执行的能力，让业务最终执行成功，达到最终一致性的目的。

























